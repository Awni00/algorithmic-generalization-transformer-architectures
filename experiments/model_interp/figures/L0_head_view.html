<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>      
        <div id="bertviz-a217b1a6aa684d59be39c23aa6e6a391" style="font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;">
            <span style="user-select:none">
                Layer: <select id="layer"></select>
                
            </span>
            <div id='vis'></div>
        </div>
    
<script type="text/javascript">
/**
 * @fileoverview Transformer Visualization D3 javascript code.
 *
 *
 *  Based on: https://github.com/tensorflow/tensor2tensor/blob/master/tensor2tensor/visualization/attention.js
 *
 * Change log:
 *
 * 12/19/18  Jesse Vig   Assorted cleanup. Changed orientation of attention matrices.
 * 12/29/20  Jesse Vig   Significant refactor.
 * 12/31/20  Jesse Vig   Support multiple visualizations in single notebook.
 * 02/06/21  Jesse Vig   Move require config from separate jupyter notebook step
 * 05/03/21  Jesse Vig   Adjust height of visualization dynamically
 * 07/25/21  Jesse Vig   Support layer filtering
 * 03/23/22  Daniel SC   Update requirement URLs for d3 and jQuery (source of bug not allowing end result to be displayed on browsers)
 **/

require.config({
  paths: {
      d3: 'https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min',
    jquery: 'https://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.0/jquery.min',
  }
});

requirejs(['jquery', 'd3'], function ($, d3) {

    const params = {"attention": [{"name": null, "attn": [[[[0.0001499970821896568, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.002519960980862379, 8.98662801773753e-06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [6.841481808805838e-05, 0.00044485245598480105, 2.7107436835649423e-05, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0040595256723463535, 4.32820561400149e-05, 0.00017194458632729948, 1.8178589016315527e-05, 0.0, 0.0, 0.0, 0.0], [0.00013431570550892502, 6.52441376587376e-05, 2.602159474918153e-05, 0.00030928076012060046, 2.731078893702943e-05, 0.0, 0.0, 0.0], [0.005102021154016256, 9.49631939874962e-05, 0.0003551120462361723, 8.35791215649806e-05, 0.00019871890253853053, 2.1009256670367904e-05, 0.0, 0.0], [0.0012363709975033998, 0.012747569009661674, 0.0018082164460793138, 0.005548278335481882, 0.0008024980779737234, 0.004284069407731295, 0.0012357264058664441, 0.0], [0.0016595828346908092, 3.4951452107634395e-05, 0.0006175163434818387, 0.00019022512424271554, 0.00037635580520145595, 6.146104715298861e-05, 0.0005590294022113085, 1.2513796718849335e-05]], [[4.9292706535197794e-05, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.00019136982155032456, 0.9787096977233887, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.004329931456595659, 0.2138841450214386, 0.0005621443851850927, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0003539299650583416, 3.622058284236118e-05, 3.450945587246679e-05, 0.9843524098396301, 0.0, 0.0, 0.0, 0.0], [0.0010626749135553837, 0.010249932296574116, 0.00945642776787281, 0.12827681005001068, 0.0006176132010295987, 0.0, 0.0, 0.0], [0.0001197738092741929, 1.9521534341038205e-05, 9.45962019613944e-05, 6.66385458316654e-05, 3.4504166251281276e-05, 0.9842014908790588, 0.0, 0.0], [0.00037036853609606624, 6.377676618285477e-05, 0.0004908576956950128, 7.998764885996934e-06, 0.00012028709170408547, 0.0001851543056545779, 1.2491284905991051e-05, 0.0], [0.0007312984089367092, 1.4364244634634815e-05, 0.00013606235734187067, 3.430533251957968e-05, 0.00011182784510310739, 4.846633964916691e-05, 2.783543459372595e-05, 0.9845676422119141]], [[0.001196777680888772, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0017766384407877922, 6.765227590221912e-05, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.00045489193871617317, 0.0003466430935077369, 8.056841761572286e-05, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0027844649739563465, 0.00028324141749180853, 0.0008948259055614471, 8.594495011493564e-05, 0.0, 0.0, 0.0, 0.0], [0.002515246393159032, 4.3492167606018484e-05, 9.34716226765886e-05, 0.00018373744387645274, 8.015385537873954e-05, 0.0, 0.0, 0.0], [0.0018349481979385018, 0.003504206659272313, 0.0026421474758535624, 0.00037540585617534816, 0.0009395417291671038, 9.023980237543583e-05, 0.0, 0.0], [0.00184902164619416, 0.0019121028017252684, 0.007567232940346003, 0.001113333972170949, 0.0054910918697714806, 0.000535476952791214, 0.0016879333416000009, 0.0], [0.003322029486298561, 0.005103203933686018, 0.001371402177028358, 0.0058365799486637115, 0.002934930147603154, 0.00034427628270350397, 0.0056823305785655975, 9.504326590104029e-05]], [[0.0004637248639483005, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.00012839672854170203, 2.275738734169863e-05, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.00016760396829340607, 0.0004262642178218812, 5.957609391771257e-05, 0.0, 0.0, 0.0, 0.0, 0.0], [0.035181839019060135, 3.3932089991139947e-06, 8.350188181793783e-06, 4.670154794439441e-06, 0.0, 0.0, 0.0, 0.0], [0.0003898690629284829, 1.4696373909828253e-05, 9.3634138465859e-05, 0.0007627321174368262, 5.733699435950257e-05, 0.0, 0.0, 0.0], [0.9467287063598633, 4.106716369278729e-05, 4.661416824092157e-05, 8.659615559736267e-06, 1.5499923392781056e-05, 8.668911505083088e-06, 0.0, 0.0], [0.0004905704990960658, 0.0009437318076379597, 0.0005392823368310928, 0.0031517259776592255, 0.0010530464351177216, 0.0012818085961043835, 0.00328091811388731, 0.0], [0.0004226301971357316, 0.00032096391078084707, 0.002071911934763193, 0.0008443141705356538, 0.0010521826334297657, 0.0001462055806769058, 0.00047684877063147724, 0.00011081890988862142]], [[0.0004942751838825643, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.010658711194992065, 0.00019518884073477238, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0005983939627185464, 0.0002216689317720011, 0.0003347279562149197, 0.0, 0.0, 0.0, 0.0, 0.0], [0.014512814581394196, 0.00010589064186206087, 0.012421547435224056, 0.00017928279703482985, 0.0, 0.0, 0.0, 0.0], [0.00022741041902918369, 0.00030520479776896536, 5.6492652220185846e-05, 0.00035644357558339834, 0.00018992554396390915, 0.0, 0.0, 0.0], [0.02013811469078064, 4.9195572501048446e-05, 0.007448047865182161, 8.545118907932192e-05, 0.012027190998196602, 0.00017359094636049122, 0.0, 0.0], [0.00023707561194896698, 0.0014704513596370816, 7.436754913214827e-06, 0.0010619349777698517, 3.419168933760375e-05, 0.0006062850006856024, 0.0005604648613370955, 0.0], [3.4593995223985985e-05, 4.6237300921347924e-07, 4.335886114859022e-05, 3.223146620712214e-07, 3.2728799851611257e-05, 5.833075533701049e-07, 0.9941294193267822, 1.4588051726605045e-06]], [[0.00037104153307154775, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.9978569149971008, 7.4345216489746235e-06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0002075065567623824, 2.0713996491394937e-06, 3.817153628915548e-05, 0.0, 0.0, 0.0, 0.0, 0.0], [8.09275150004396e-07, 0.00034248686279170215, 0.9996418952941895, 3.159868811053457e-07, 0.0, 0.0, 0.0, 0.0], [5.550183414015919e-05, 1.4188306067808298e-06, 0.00025056570302695036, 2.0977688109269366e-05, 3.815376476268284e-05, 0.0, 0.0, 0.0], [9.417072988071595e-07, 1.1789614262625037e-07, 5.316897500051709e-07, 0.0008684938657097518, 0.9991162419319153, 3.1582072779201553e-07, 0.0, 0.0], [0.00019916784367524087, 0.0005836120108142495, 0.0001671561476541683, 0.0004857238964177668, 0.00283508887514472, 0.0005001876852475107, 0.002191833918914199, 0.0], [0.00043616697075776756, 9.51910624280572e-05, 0.0003055721172131598, 0.00010351907985750586, 0.0002564732567407191, 0.9885371923446655, 0.0032536687795072794, 0.0002169831277569756]], [[0.0011734907748177648, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [1.7205265976372175e-05, 3.022900091309566e-05, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.000144675635965541, 0.00014382245717570186, 3.2234445825451985e-05, 0.0, 0.0, 0.0, 0.0, 0.0], [0.010253212414681911, 0.0005638551665470004, 0.1315675675868988, 0.0002525591116864234, 0.0, 0.0, 0.0, 0.0], [0.003584423800930381, 2.6673576940083876e-05, 2.2594605979975313e-05, 0.0003854880924336612, 3.1869883969193324e-05, 0.0, 0.0, 0.0], [7.563523354292556e-07, 2.7347757622919744e-06, 0.9760867953300476, 1.416205759596778e-05, 0.0031703722197562456, 6.085897894081427e-06, 0.0, 0.0], [0.00038480653893202543, 0.0006986990920267999, 0.0010297431144863367, 0.002116007497534156, 0.00052203907398507, 0.0002796626358758658, 0.003414890030398965, 0.0], [2.644297012466268e-07, 4.0450609049003106e-06, 0.00010023530194303021, 9.141798500422738e-07, 0.9843730926513672, 8.103353138722014e-06, 2.9135217118891887e-05, 2.6922873530565994e-06]], [[0.0004556288185995072, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.00014014597400091588, 8.748997061047703e-06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0003049269726034254, 6.975841097300872e-05, 0.00014335676678456366, 0.0, 0.0, 0.0, 0.0, 0.0], [0.014348435215651989, 3.8772239463469305e-07, 3.4322745534609567e-08, 2.0373532549911033e-07, 0.0, 0.0, 0.0, 0.0], [0.0017225787742063403, 2.164424404327292e-05, 0.0002838793152477592, 7.650022598681971e-05, 0.00014314844156615436, 0.0, 0.0, 0.0], [0.9907616972923279, 3.519972096910351e-06, 3.4499021239753347e-06, 7.15155067609885e-07, 5.145341219758848e-08, 3.054204569252761e-07, 0.0, 0.0], [0.0007702470757067204, 2.8564196327351965e-05, 0.0021685566753149033, 8.816151967039332e-05, 0.001127061783336103, 8.400698425248265e-05, 0.0017085302388295531, 0.0], [0.00037474019336514175, 0.0004715329851023853, 0.0014515244401991367, 0.0004661807033699006, 0.0004869263502769172, 8.704137144377455e-05, 0.0009979509050026536, 4.959590660291724e-05]], [[0.00022844443446956575, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [2.238652285768694e-08, 2.834742076629482e-07, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [5.872645851923153e-05, 6.775811925763264e-05, 8.090566552709788e-05, 0.0, 0.0, 0.0, 0.0, 0.0], [9.946908221536432e-07, 3.9792658412807214e-07, 7.029853321682822e-08, 2.2457952297827433e-07, 0.0, 0.0, 0.0, 0.0], [0.0007220312254503369, 8.318345862790011e-06, 6.452474917750806e-05, 3.939474845537916e-05, 8.095644443528727e-05, 0.0, 0.0, 0.0], [0.0002894045028369874, 0.9849742650985718, 0.0004261080175638199, 4.058088961755857e-05, 6.043972007319098e-06, 1.9308403352624737e-05, 0.0, 0.0], [0.0012516595888882875, 0.00046145968372002244, 0.05727376416325569, 0.0004290768411010504, 0.002362570958212018, 0.0001372390688629821, 0.008840582333505154, 0.0], [1.6897265595616773e-05, 0.0001840907643781975, 0.004897063132375479, 0.9811145663261414, 0.0005652157124131918, 1.9335288016009144e-05, 0.000374501891201362, 9.357998351333663e-06]], [[0.004911371506750584, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0021781539544463158, 0.00014835206093266606, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0003072794934269041, 0.0003052973479498178, 0.0002289334952365607, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0002619965234771371, 0.00010299104906152934, 0.0015739056980237365, 8.522085408912972e-05, 0.0, 0.0, 0.0, 0.0], [0.000216596745303832, 0.0001660106354393065, 5.730010525439866e-05, 0.00021083703904878348, 0.0002335449680685997, 0.0, 0.0, 0.0], [6.413405208149925e-05, 5.797098856419325e-05, 3.413618105696514e-05, 5.2302973926998675e-05, 0.0015717975329607725, 8.51067088660784e-05, 0.0, 0.0], [0.0009410474449396133, 0.007088883779942989, 0.0012446730397641659, 0.0014039226807653904, 0.002104734303429723, 0.001114198355935514, 0.01532783918082714, 0.0], [0.0006578663014806807, 6.238930654944852e-05, 8.887101103027817e-06, 2.928300091298297e-05, 3.4519802284194157e-05, 5.7533688959665596e-05, 0.0030369830783456564, 8.684991917107254e-05]], [[9.733456863614265e-06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.7275589108467102, 5.020567186875269e-06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0025198902003467083, 3.6826461324857007e-10, 0.0004169945896137506, 0.0, 0.0, 0.0, 0.0, 0.0], [6.53845427223132e-06, 4.158859781000501e-07, 0.9644718766212463, 1.6168582988029812e-06, 0.0, 0.0, 0.0, 0.0], [0.0005911898333579302, 9.790704247336635e-09, 0.007529555354267359, 7.462605533525846e-10, 0.00041495118057355285, 0.0, 0.0, 0.0], [2.3620582396688405e-06, 5.875781994291174e-07, 4.4513567445392255e-06, 1.0418684723845217e-06, 0.9644075632095337, 1.6167504099939833e-06, 0.0, 0.0], [0.00017362051585223526, 9.614422197046224e-06, 4.5296063035493717e-05, 6.46740008960478e-05, 0.0001852032437454909, 3.8273645941444556e-07, 0.00012107811926398426, 0.0], [0.00019899295875802636, 5.399274414230604e-06, 5.969306221231818e-05, 1.871111453510821e-05, 0.00012133773270761594, 1.5654331946279854e-05, 0.003375834319740534, 1.6248530300799757e-05]], [[0.0003587262181099504, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.9913491606712341, 1.0512108929106034e-05, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [9.80138938757591e-05, 7.927927799755707e-05, 0.00011707692465279251, 0.0, 0.0, 0.0, 0.0, 0.0], [4.1394704908270796e-07, 0.002912084339186549, 0.9970433115959167, 1.7606839719519485e-06, 0.0, 0.0, 0.0, 0.0], [6.198515620781109e-05, 2.040104845946189e-06, 8.958396210800856e-05, 5.795791366836056e-05, 0.00011632856330834329, 0.0, 0.0, 0.0], [6.33537183603039e-07, 1.832245430932744e-07, 5.333595254342072e-07, 0.002792703453451395, 0.9971627593040466, 1.760894861035922e-06, 0.0, 0.0], [6.436029798351228e-05, 4.8830585001269355e-05, 3.1362818845082074e-05, 0.00019977212650701404, 0.0003055162960663438, 9.906396007863805e-05, 0.0038879283238202333, 0.0], [0.00015493416867684573, 7.184851710917428e-05, 0.0003227608685847372, 5.9037211030954495e-05, 0.00020724751811940223, 0.980585515499115, 0.002179612871259451, 0.00036404133425094187]], [[0.0001666099124122411, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.005445799324661493, 0.00021267378178890795, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [5.144166061654687e-05, 0.00019405920465942472, 2.61485947703477e-05, 0.0, 0.0, 0.0, 0.0, 0.0], [0.004987398162484169, 4.568922668113373e-05, 6.63115679344628e-06, 6.188408406160306e-06, 0.0, 0.0, 0.0, 0.0], [0.00023814124870114028, 3.493053372949362e-05, 1.3363400285015814e-05, 0.00044473083107732236, 2.565764225437306e-05, 0.0, 0.0, 0.0], [0.9740245342254639, 8.068587339948863e-05, 7.076554902596399e-05, 9.170082921627909e-05, 8.428107321378775e-06, 7.86538021202432e-06, 0.0, 0.0], [0.00032784714130684733, 0.004578887950628996, 0.001027983147650957, 0.00871965941041708, 0.0006370936171151698, 0.005861029028892517, 0.0004915421595796943, 0.0], [0.002411862136796117, 0.00145544926635921, 0.008206460624933243, 0.004303626250475645, 0.0022413081023842096, 0.003943490795791149, 0.007986466400325298, 0.00019258219981566072]], [[0.0002856238861568272, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.00508638471364975, 0.02038433775305748, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [4.555070700007491e-05, 1.4826688129687682e-05, 0.00018354554777033627, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0002696102892514318, 0.9859814643859863, 9.875340765574947e-05, 0.00031170438160188496, 0.0, 0.0, 0.0, 0.0], [0.0001232231588801369, 1.6702057337170118e-06, 0.00012166712258476764, 3.772115451283753e-05, 0.00018903047021012753, 0.0, 0.0, 0.0], [0.003794478951022029, 0.00021977457799948752, 0.0001590816245879978, 0.9835679531097412, 0.00010589382145553827, 0.00033424264984205365, 0.0, 0.0], [0.00014574093802366406, 0.0002797520428430289, 0.0004834967839997262, 6.111666152719408e-05, 0.005929323844611645, 0.00027783174300566316, 0.000660865509416908, 0.0], [0.00014138086407911032, 0.00010425179789308459, 0.00977371446788311, 0.00014236709102988243, 0.00019961415091529489, 0.9836599826812744, 0.00015398662071675062, 0.0002564795722719282]], [[0.08958535641431808, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [2.7437424705567537e-06, 7.988473771369797e-10, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.027741732075810432, 0.0006900222506374121, 3.518634912325069e-05, 0.0, 0.0, 0.0, 0.0, 0.0], [0.013222319073975086, 2.2860105475253079e-10, 2.3253127938785423e-13, 5.0264518242082445e-11, 0.0, 0.0, 0.0, 0.0], [0.025772929191589355, 0.000676274998113513, 5.8415589592186734e-05, 0.0004910529241897166, 3.538343298714608e-05, 0.0, 0.0, 0.0], [0.9999878406524658, 2.2436241753354125e-09, 2.9545696444976954e-10, 1.3586114178121278e-10, 9.185186655323238e-14, 1.9854881627701104e-11, 0.0, 0.0], [6.523617776110768e-05, 0.0003955156134907156, 0.0010368801886215806, 0.00021331523021217436, 7.198300590971485e-05, 0.0013582281535491347, 0.0006900678272359073, 0.0], [0.0006190775311551988, 0.988565981388092, 0.0010373620316386223, 0.0001354087289655581, 4.5689925173064694e-05, 5.226277153269621e-06, 0.000437140348367393, 8.644267381896498e-07]], [[0.001195914694108069, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0022057625465095043, 0.2091549187898636, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.000669311557430774, 0.0002496283268555999, 0.002959082368761301, 0.0, 0.0, 0.0, 0.0, 0.0], [0.019335472956299782, 0.00041779433377087116, 0.003395537845790386, 0.20208600163459778, 0.0, 0.0, 0.0, 0.0], [0.0010500705102458596, 0.0002614081313367933, 0.00029198668198660016, 0.00016976452025119215, 0.002957922173663974, 0.0, 0.0, 0.0], [0.023094143718481064, 0.00029028550488874316, 0.007309301290661097, 0.0007326161721721292, 0.00332688819617033, 0.19800031185150146, 0.0, 0.0], [0.002733702538534999, 0.0008136748219840229, 0.006415834184736013, 0.0005886091385036707, 0.0030423589050769806, 0.0003023615572601557, 0.0028704660944640636, 0.0], [0.016702452674508095, 0.00022981595247983932, 0.006576333194971085, 0.000497093831654638, 0.007785429712384939, 0.000736902526114136, 0.009344900026917458, 0.3129320442676544]]]], "left_text": ["<SEP>", "x_13", "ADD", "x_0", "ADD", "x_0", "=", "x_127"], "right_text": ["<SEP>", "x_13", "ADD", "x_0", "ADD", "x_0", "=", "x_127"]}], "default_filter": "0", "root_div_id": "bertviz-a217b1a6aa684d59be39c23aa6e6a391", "layer": null, "heads": null, "include_layers": [0]}; // HACK: {"attention": [{"name": null, "attn": [[[[0.0001499970821896568, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.002519960980862379, 8.98662801773753e-06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [6.841481808805838e-05, 0.00044485245598480105, 2.7107436835649423e-05, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0040595256723463535, 4.32820561400149e-05, 0.00017194458632729948, 1.8178589016315527e-05, 0.0, 0.0, 0.0, 0.0], [0.00013431570550892502, 6.52441376587376e-05, 2.602159474918153e-05, 0.00030928076012060046, 2.731078893702943e-05, 0.0, 0.0, 0.0], [0.005102021154016256, 9.49631939874962e-05, 0.0003551120462361723, 8.35791215649806e-05, 0.00019871890253853053, 2.1009256670367904e-05, 0.0, 0.0], [0.0012363709975033998, 0.012747569009661674, 0.0018082164460793138, 0.005548278335481882, 0.0008024980779737234, 0.004284069407731295, 0.0012357264058664441, 0.0], [0.0016595828346908092, 3.4951452107634395e-05, 0.0006175163434818387, 0.00019022512424271554, 0.00037635580520145595, 6.146104715298861e-05, 0.0005590294022113085, 1.2513796718849335e-05]], [[4.9292706535197794e-05, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.00019136982155032456, 0.9787096977233887, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.004329931456595659, 0.2138841450214386, 0.0005621443851850927, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0003539299650583416, 3.622058284236118e-05, 3.450945587246679e-05, 0.9843524098396301, 0.0, 0.0, 0.0, 0.0], [0.0010626749135553837, 0.010249932296574116, 0.00945642776787281, 0.12827681005001068, 0.0006176132010295987, 0.0, 0.0, 0.0], [0.0001197738092741929, 1.9521534341038205e-05, 9.45962019613944e-05, 6.66385458316654e-05, 3.4504166251281276e-05, 0.9842014908790588, 0.0, 0.0], [0.00037036853609606624, 6.377676618285477e-05, 0.0004908576956950128, 7.998764885996934e-06, 0.00012028709170408547, 0.0001851543056545779, 1.2491284905991051e-05, 0.0], [0.0007312984089367092, 1.4364244634634815e-05, 0.00013606235734187067, 3.430533251957968e-05, 0.00011182784510310739, 4.846633964916691e-05, 2.783543459372595e-05, 0.9845676422119141]], [[0.001196777680888772, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0017766384407877922, 6.765227590221912e-05, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.00045489193871617317, 0.0003466430935077369, 8.056841761572286e-05, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0027844649739563465, 0.00028324141749180853, 0.0008948259055614471, 8.594495011493564e-05, 0.0, 0.0, 0.0, 0.0], [0.002515246393159032, 4.3492167606018484e-05, 9.34716226765886e-05, 0.00018373744387645274, 8.015385537873954e-05, 0.0, 0.0, 0.0], [0.0018349481979385018, 0.003504206659272313, 0.0026421474758535624, 0.00037540585617534816, 0.0009395417291671038, 9.023980237543583e-05, 0.0, 0.0], [0.00184902164619416, 0.0019121028017252684, 0.007567232940346003, 0.001113333972170949, 0.0054910918697714806, 0.000535476952791214, 0.0016879333416000009, 0.0], [0.003322029486298561, 0.005103203933686018, 0.001371402177028358, 0.0058365799486637115, 0.002934930147603154, 0.00034427628270350397, 0.0056823305785655975, 9.504326590104029e-05]], [[0.0004637248639483005, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.00012839672854170203, 2.275738734169863e-05, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.00016760396829340607, 0.0004262642178218812, 5.957609391771257e-05, 0.0, 0.0, 0.0, 0.0, 0.0], [0.035181839019060135, 3.3932089991139947e-06, 8.350188181793783e-06, 4.670154794439441e-06, 0.0, 0.0, 0.0, 0.0], [0.0003898690629284829, 1.4696373909828253e-05, 9.3634138465859e-05, 0.0007627321174368262, 5.733699435950257e-05, 0.0, 0.0, 0.0], [0.9467287063598633, 4.106716369278729e-05, 4.661416824092157e-05, 8.659615559736267e-06, 1.5499923392781056e-05, 8.668911505083088e-06, 0.0, 0.0], [0.0004905704990960658, 0.0009437318076379597, 0.0005392823368310928, 0.0031517259776592255, 0.0010530464351177216, 0.0012818085961043835, 0.00328091811388731, 0.0], [0.0004226301971357316, 0.00032096391078084707, 0.002071911934763193, 0.0008443141705356538, 0.0010521826334297657, 0.0001462055806769058, 0.00047684877063147724, 0.00011081890988862142]], [[0.0004942751838825643, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.010658711194992065, 0.00019518884073477238, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0005983939627185464, 0.0002216689317720011, 0.0003347279562149197, 0.0, 0.0, 0.0, 0.0, 0.0], [0.014512814581394196, 0.00010589064186206087, 0.012421547435224056, 0.00017928279703482985, 0.0, 0.0, 0.0, 0.0], [0.00022741041902918369, 0.00030520479776896536, 5.6492652220185846e-05, 0.00035644357558339834, 0.00018992554396390915, 0.0, 0.0, 0.0], [0.02013811469078064, 4.9195572501048446e-05, 0.007448047865182161, 8.545118907932192e-05, 0.012027190998196602, 0.00017359094636049122, 0.0, 0.0], [0.00023707561194896698, 0.0014704513596370816, 7.436754913214827e-06, 0.0010619349777698517, 3.419168933760375e-05, 0.0006062850006856024, 0.0005604648613370955, 0.0], [3.4593995223985985e-05, 4.6237300921347924e-07, 4.335886114859022e-05, 3.223146620712214e-07, 3.2728799851611257e-05, 5.833075533701049e-07, 0.9941294193267822, 1.4588051726605045e-06]], [[0.00037104153307154775, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.9978569149971008, 7.4345216489746235e-06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0002075065567623824, 2.0713996491394937e-06, 3.817153628915548e-05, 0.0, 0.0, 0.0, 0.0, 0.0], [8.09275150004396e-07, 0.00034248686279170215, 0.9996418952941895, 3.159868811053457e-07, 0.0, 0.0, 0.0, 0.0], [5.550183414015919e-05, 1.4188306067808298e-06, 0.00025056570302695036, 2.0977688109269366e-05, 3.815376476268284e-05, 0.0, 0.0, 0.0], [9.417072988071595e-07, 1.1789614262625037e-07, 5.316897500051709e-07, 0.0008684938657097518, 0.9991162419319153, 3.1582072779201553e-07, 0.0, 0.0], [0.00019916784367524087, 0.0005836120108142495, 0.0001671561476541683, 0.0004857238964177668, 0.00283508887514472, 0.0005001876852475107, 0.002191833918914199, 0.0], [0.00043616697075776756, 9.51910624280572e-05, 0.0003055721172131598, 0.00010351907985750586, 0.0002564732567407191, 0.9885371923446655, 0.0032536687795072794, 0.0002169831277569756]], [[0.0011734907748177648, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [1.7205265976372175e-05, 3.022900091309566e-05, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.000144675635965541, 0.00014382245717570186, 3.2234445825451985e-05, 0.0, 0.0, 0.0, 0.0, 0.0], [0.010253212414681911, 0.0005638551665470004, 0.1315675675868988, 0.0002525591116864234, 0.0, 0.0, 0.0, 0.0], [0.003584423800930381, 2.6673576940083876e-05, 2.2594605979975313e-05, 0.0003854880924336612, 3.1869883969193324e-05, 0.0, 0.0, 0.0], [7.563523354292556e-07, 2.7347757622919744e-06, 0.9760867953300476, 1.416205759596778e-05, 0.0031703722197562456, 6.085897894081427e-06, 0.0, 0.0], [0.00038480653893202543, 0.0006986990920267999, 0.0010297431144863367, 0.002116007497534156, 0.00052203907398507, 0.0002796626358758658, 0.003414890030398965, 0.0], [2.644297012466268e-07, 4.0450609049003106e-06, 0.00010023530194303021, 9.141798500422738e-07, 0.9843730926513672, 8.103353138722014e-06, 2.9135217118891887e-05, 2.6922873530565994e-06]], [[0.0004556288185995072, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.00014014597400091588, 8.748997061047703e-06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0003049269726034254, 6.975841097300872e-05, 0.00014335676678456366, 0.0, 0.0, 0.0, 0.0, 0.0], [0.014348435215651989, 3.8772239463469305e-07, 3.4322745534609567e-08, 2.0373532549911033e-07, 0.0, 0.0, 0.0, 0.0], [0.0017225787742063403, 2.164424404327292e-05, 0.0002838793152477592, 7.650022598681971e-05, 0.00014314844156615436, 0.0, 0.0, 0.0], [0.9907616972923279, 3.519972096910351e-06, 3.4499021239753347e-06, 7.15155067609885e-07, 5.145341219758848e-08, 3.054204569252761e-07, 0.0, 0.0], [0.0007702470757067204, 2.8564196327351965e-05, 0.0021685566753149033, 8.816151967039332e-05, 0.001127061783336103, 8.400698425248265e-05, 0.0017085302388295531, 0.0], [0.00037474019336514175, 0.0004715329851023853, 0.0014515244401991367, 0.0004661807033699006, 0.0004869263502769172, 8.704137144377455e-05, 0.0009979509050026536, 4.959590660291724e-05]], [[0.00022844443446956575, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [2.238652285768694e-08, 2.834742076629482e-07, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [5.872645851923153e-05, 6.775811925763264e-05, 8.090566552709788e-05, 0.0, 0.0, 0.0, 0.0, 0.0], [9.946908221536432e-07, 3.9792658412807214e-07, 7.029853321682822e-08, 2.2457952297827433e-07, 0.0, 0.0, 0.0, 0.0], [0.0007220312254503369, 8.318345862790011e-06, 6.452474917750806e-05, 3.939474845537916e-05, 8.095644443528727e-05, 0.0, 0.0, 0.0], [0.0002894045028369874, 0.9849742650985718, 0.0004261080175638199, 4.058088961755857e-05, 6.043972007319098e-06, 1.9308403352624737e-05, 0.0, 0.0], [0.0012516595888882875, 0.00046145968372002244, 0.05727376416325569, 0.0004290768411010504, 0.002362570958212018, 0.0001372390688629821, 0.008840582333505154, 0.0], [1.6897265595616773e-05, 0.0001840907643781975, 0.004897063132375479, 0.9811145663261414, 0.0005652157124131918, 1.9335288016009144e-05, 0.000374501891201362, 9.357998351333663e-06]], [[0.004911371506750584, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0021781539544463158, 0.00014835206093266606, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0003072794934269041, 0.0003052973479498178, 0.0002289334952365607, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0002619965234771371, 0.00010299104906152934, 0.0015739056980237365, 8.522085408912972e-05, 0.0, 0.0, 0.0, 0.0], [0.000216596745303832, 0.0001660106354393065, 5.730010525439866e-05, 0.00021083703904878348, 0.0002335449680685997, 0.0, 0.0, 0.0], [6.413405208149925e-05, 5.797098856419325e-05, 3.413618105696514e-05, 5.2302973926998675e-05, 0.0015717975329607725, 8.51067088660784e-05, 0.0, 0.0], [0.0009410474449396133, 0.007088883779942989, 0.0012446730397641659, 0.0014039226807653904, 0.002104734303429723, 0.001114198355935514, 0.01532783918082714, 0.0], [0.0006578663014806807, 6.238930654944852e-05, 8.887101103027817e-06, 2.928300091298297e-05, 3.4519802284194157e-05, 5.7533688959665596e-05, 0.0030369830783456564, 8.684991917107254e-05]], [[9.733456863614265e-06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.7275589108467102, 5.020567186875269e-06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0025198902003467083, 3.6826461324857007e-10, 0.0004169945896137506, 0.0, 0.0, 0.0, 0.0, 0.0], [6.53845427223132e-06, 4.158859781000501e-07, 0.9644718766212463, 1.6168582988029812e-06, 0.0, 0.0, 0.0, 0.0], [0.0005911898333579302, 9.790704247336635e-09, 0.007529555354267359, 7.462605533525846e-10, 0.00041495118057355285, 0.0, 0.0, 0.0], [2.3620582396688405e-06, 5.875781994291174e-07, 4.4513567445392255e-06, 1.0418684723845217e-06, 0.9644075632095337, 1.6167504099939833e-06, 0.0, 0.0], [0.00017362051585223526, 9.614422197046224e-06, 4.5296063035493717e-05, 6.46740008960478e-05, 0.0001852032437454909, 3.8273645941444556e-07, 0.00012107811926398426, 0.0], [0.00019899295875802636, 5.399274414230604e-06, 5.969306221231818e-05, 1.871111453510821e-05, 0.00012133773270761594, 1.5654331946279854e-05, 0.003375834319740534, 1.6248530300799757e-05]], [[0.0003587262181099504, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.9913491606712341, 1.0512108929106034e-05, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [9.80138938757591e-05, 7.927927799755707e-05, 0.00011707692465279251, 0.0, 0.0, 0.0, 0.0, 0.0], [4.1394704908270796e-07, 0.002912084339186549, 0.9970433115959167, 1.7606839719519485e-06, 0.0, 0.0, 0.0, 0.0], [6.198515620781109e-05, 2.040104845946189e-06, 8.958396210800856e-05, 5.795791366836056e-05, 0.00011632856330834329, 0.0, 0.0, 0.0], [6.33537183603039e-07, 1.832245430932744e-07, 5.333595254342072e-07, 0.002792703453451395, 0.9971627593040466, 1.760894861035922e-06, 0.0, 0.0], [6.436029798351228e-05, 4.8830585001269355e-05, 3.1362818845082074e-05, 0.00019977212650701404, 0.0003055162960663438, 9.906396007863805e-05, 0.0038879283238202333, 0.0], [0.00015493416867684573, 7.184851710917428e-05, 0.0003227608685847372, 5.9037211030954495e-05, 0.00020724751811940223, 0.980585515499115, 0.002179612871259451, 0.00036404133425094187]], [[0.0001666099124122411, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.005445799324661493, 0.00021267378178890795, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [5.144166061654687e-05, 0.00019405920465942472, 2.61485947703477e-05, 0.0, 0.0, 0.0, 0.0, 0.0], [0.004987398162484169, 4.568922668113373e-05, 6.63115679344628e-06, 6.188408406160306e-06, 0.0, 0.0, 0.0, 0.0], [0.00023814124870114028, 3.493053372949362e-05, 1.3363400285015814e-05, 0.00044473083107732236, 2.565764225437306e-05, 0.0, 0.0, 0.0], [0.9740245342254639, 8.068587339948863e-05, 7.076554902596399e-05, 9.170082921627909e-05, 8.428107321378775e-06, 7.86538021202432e-06, 0.0, 0.0], [0.00032784714130684733, 0.004578887950628996, 0.001027983147650957, 0.00871965941041708, 0.0006370936171151698, 0.005861029028892517, 0.0004915421595796943, 0.0], [0.002411862136796117, 0.00145544926635921, 0.008206460624933243, 0.004303626250475645, 0.0022413081023842096, 0.003943490795791149, 0.007986466400325298, 0.00019258219981566072]], [[0.0002856238861568272, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.00508638471364975, 0.02038433775305748, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [4.555070700007491e-05, 1.4826688129687682e-05, 0.00018354554777033627, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0002696102892514318, 0.9859814643859863, 9.875340765574947e-05, 0.00031170438160188496, 0.0, 0.0, 0.0, 0.0], [0.0001232231588801369, 1.6702057337170118e-06, 0.00012166712258476764, 3.772115451283753e-05, 0.00018903047021012753, 0.0, 0.0, 0.0], [0.003794478951022029, 0.00021977457799948752, 0.0001590816245879978, 0.9835679531097412, 0.00010589382145553827, 0.00033424264984205365, 0.0, 0.0], [0.00014574093802366406, 0.0002797520428430289, 0.0004834967839997262, 6.111666152719408e-05, 0.005929323844611645, 0.00027783174300566316, 0.000660865509416908, 0.0], [0.00014138086407911032, 0.00010425179789308459, 0.00977371446788311, 0.00014236709102988243, 0.00019961415091529489, 0.9836599826812744, 0.00015398662071675062, 0.0002564795722719282]], [[0.08958535641431808, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [2.7437424705567537e-06, 7.988473771369797e-10, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.027741732075810432, 0.0006900222506374121, 3.518634912325069e-05, 0.0, 0.0, 0.0, 0.0, 0.0], [0.013222319073975086, 2.2860105475253079e-10, 2.3253127938785423e-13, 5.0264518242082445e-11, 0.0, 0.0, 0.0, 0.0], [0.025772929191589355, 0.000676274998113513, 5.8415589592186734e-05, 0.0004910529241897166, 3.538343298714608e-05, 0.0, 0.0, 0.0], [0.9999878406524658, 2.2436241753354125e-09, 2.9545696444976954e-10, 1.3586114178121278e-10, 9.185186655323238e-14, 1.9854881627701104e-11, 0.0, 0.0], [6.523617776110768e-05, 0.0003955156134907156, 0.0010368801886215806, 0.00021331523021217436, 7.198300590971485e-05, 0.0013582281535491347, 0.0006900678272359073, 0.0], [0.0006190775311551988, 0.988565981388092, 0.0010373620316386223, 0.0001354087289655581, 4.5689925173064694e-05, 5.226277153269621e-06, 0.000437140348367393, 8.644267381896498e-07]], [[0.001195914694108069, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.0022057625465095043, 0.2091549187898636, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.000669311557430774, 0.0002496283268555999, 0.002959082368761301, 0.0, 0.0, 0.0, 0.0, 0.0], [0.019335472956299782, 0.00041779433377087116, 0.003395537845790386, 0.20208600163459778, 0.0, 0.0, 0.0, 0.0], [0.0010500705102458596, 0.0002614081313367933, 0.00029198668198660016, 0.00016976452025119215, 0.002957922173663974, 0.0, 0.0, 0.0], [0.023094143718481064, 0.00029028550488874316, 0.007309301290661097, 0.0007326161721721292, 0.00332688819617033, 0.19800031185150146, 0.0, 0.0], [0.002733702538534999, 0.0008136748219840229, 0.006415834184736013, 0.0005886091385036707, 0.0030423589050769806, 0.0003023615572601557, 0.0028704660944640636, 0.0], [0.016702452674508095, 0.00022981595247983932, 0.006576333194971085, 0.000497093831654638, 0.007785429712384939, 0.000736902526114136, 0.009344900026917458, 0.3129320442676544]]]], "left_text": ["<SEP>", "x_13", "ADD", "x_0", "ADD", "x_0", "=", "x_127"], "right_text": ["<SEP>", "x_13", "ADD", "x_0", "ADD", "x_0", "=", "x_127"]}], "default_filter": "0", "root_div_id": "bertviz-a217b1a6aa684d59be39c23aa6e6a391", "layer": null, "heads": null, "include_layers": [0]} is a template marker that is replaced by actual params.
    const TEXT_SIZE = 15;
    const BOXWIDTH = 110;
    const BOXHEIGHT = 22.5;
    const MATRIX_WIDTH = 115;
    const CHECKBOX_SIZE = 20;
    const TEXT_TOP = 30;

    console.log("d3 version", d3.version)
    let headColors;
    try {
        headColors = d3.scaleOrdinal(d3.schemeCategory10);
    } catch (err) {
        console.log('Older d3 version')
        headColors = d3.scale.category10();
    }
    let config = {};
    initialize();
    renderVis();

    function initialize() {
        config.attention = params['attention'];
        config.filter = params['default_filter'];
        config.rootDivId = params['root_div_id'];
        config.nLayers = config.attention[config.filter]['attn'].length;
        config.nHeads = config.attention[config.filter]['attn'][0].length;
        config.layers = params['include_layers']

        if (params['heads']) {
            config.headVis = new Array(config.nHeads).fill(false);
            params['heads'].forEach(x => config.headVis[x] = true);
        } else {
            config.headVis = new Array(config.nHeads).fill(true);
        }
        config.initialTextLength = config.attention[config.filter].right_text.length;
        config.layer_seq = (params['layer'] == null ? 0 : config.layers.findIndex(layer => params['layer'] === layer));
        config.layer = config.layers[config.layer_seq]

        let layerEl = $(`#${config.rootDivId} #layer`);
        for (const layer of config.layers) {
            layerEl.append($("<option />").val(layer).text(layer));
        }
        layerEl.val(config.layer).change();
        layerEl.on('change', function (e) {
            config.layer = +e.currentTarget.value;
            config.layer_seq = config.layers.findIndex(layer => config.layer === layer);
            renderVis();
        });

        $(`#${config.rootDivId} #filter`).on('change', function (e) {
            config.filter = e.currentTarget.value;
            renderVis();
        });
    }

    function renderVis() {

        // Load parameters
        const attnData = config.attention[config.filter];
        const leftText = attnData.left_text;
        const rightText = attnData.right_text;

        // Select attention for given layer
        const layerAttention = attnData.attn[config.layer_seq];

        // Clear vis
        $(`#${config.rootDivId} #vis`).empty();

        // Determine size of visualization
        const height = Math.max(leftText.length, rightText.length) * BOXHEIGHT + TEXT_TOP;
        const svg = d3.select(`#${config.rootDivId} #vis`)
            .append('svg')
            .attr("width", "100%")
            .attr("height", height + "px");

        // Display tokens on left and right side of visualization
        renderText(svg, leftText, true, layerAttention, 0);
        renderText(svg, rightText, false, layerAttention, MATRIX_WIDTH + BOXWIDTH);

        // Render attention arcs
        renderAttention(svg, layerAttention);

        // Draw squares at top of visualization, one for each head
        drawCheckboxes(0, svg, layerAttention);
    }

    function renderText(svg, text, isLeft, attention, leftPos) {

        const textContainer = svg.append("svg:g")
            .attr("id", isLeft ? "left" : "right");

        // Add attention highlights superimposed over words
        textContainer.append("g")
            .classed("attentionBoxes", true)
            .selectAll("g")
            .data(attention)
            .enter()
            .append("g")
            .attr("head-index", (d, i) => i)
            .selectAll("rect")
            .data(d => isLeft ? d : transpose(d)) // if right text, transpose attention to get right-to-left weights
            .enter()
            .append("rect")
            .attr("x", function () {
                var headIndex = +this.parentNode.getAttribute("head-index");
                return leftPos + boxOffsets(headIndex);
            })
            .attr("y", (+1) * BOXHEIGHT)
            .attr("width", BOXWIDTH / activeHeads())
            .attr("height", BOXHEIGHT)
            .attr("fill", function () {
                return headColors(+this.parentNode.getAttribute("head-index"))
            })
            .style("opacity", 0.0);

        const tokenContainer = textContainer.append("g").selectAll("g")
            .data(text)
            .enter()
            .append("g");

        // Add gray background that appears when hovering over text
        tokenContainer.append("rect")
            .classed("background", true)
            .style("opacity", 0.0)
            .attr("fill", "lightgray")
            .attr("x", leftPos)
            .attr("y", (d, i) => TEXT_TOP + i * BOXHEIGHT)
            .attr("width", BOXWIDTH)
            .attr("height", BOXHEIGHT);

        // Add token text
        const textEl = tokenContainer.append("text")
            .text(d => d)
            .attr("font-size", TEXT_SIZE + "px")
            .style("cursor", "default")
            .style("-webkit-user-select", "none")
            .attr("x", leftPos)
            .attr("y", (d, i) => TEXT_TOP + i * BOXHEIGHT);

        if (isLeft) {
            textEl.style("text-anchor", "end")
                .attr("dx", BOXWIDTH - 0.5 * TEXT_SIZE)
                .attr("dy", TEXT_SIZE);
        } else {
            textEl.style("text-anchor", "start")
                .attr("dx", +0.5 * TEXT_SIZE)
                .attr("dy", TEXT_SIZE);
        }

        tokenContainer.on("mouseover", function (d, index) {

            // Show gray background for moused-over token
            textContainer.selectAll(".background")
                .style("opacity", (d, i) => i === index ? 1.0 : 0.0)

            // Reset visibility attribute for any previously highlighted attention arcs
            svg.select("#attention")
                .selectAll("line[visibility='visible']")
                .attr("visibility", null)

            // Hide group containing attention arcs
            svg.select("#attention").attr("visibility", "hidden");

            // Set to visible appropriate attention arcs to be highlighted
            if (isLeft) {
                svg.select("#attention").selectAll("line[left-token-index='" + index + "']").attr("visibility", "visible");
            } else {
                svg.select("#attention").selectAll("line[right-token-index='" + index + "']").attr("visibility", "visible");
            }

            // Update color boxes superimposed over tokens
            const id = isLeft ? "right" : "left";
            const leftPos = isLeft ? MATRIX_WIDTH + BOXWIDTH : 0;
            svg.select("#" + id)
                .selectAll(".attentionBoxes")
                .selectAll("g")
                .attr("head-index", (d, i) => i)
                .selectAll("rect")
                .attr("x", function () {
                    const headIndex = +this.parentNode.getAttribute("head-index");
                    return leftPos + boxOffsets(headIndex);
                })
                .attr("y", (d, i) => TEXT_TOP + i * BOXHEIGHT)
                .attr("width", BOXWIDTH / activeHeads())
                .attr("height", BOXHEIGHT)
                .style("opacity", function (d) {
                    const headIndex = +this.parentNode.getAttribute("head-index");
                    if (config.headVis[headIndex])
                        if (d) {
                            return d[index];
                        } else {
                            return 0.0;
                        }
                    else
                        return 0.0;
                });
        });

        textContainer.on("mouseleave", function () {

            // Unhighlight selected token
            d3.select(this).selectAll(".background")
                .style("opacity", 0.0);

            // Reset visibility attributes for previously selected lines
            svg.select("#attention")
                .selectAll("line[visibility='visible']")
                .attr("visibility", null) ;
            svg.select("#attention").attr("visibility", "visible");

            // Reset highlights superimposed over tokens
            svg.selectAll(".attentionBoxes")
                .selectAll("g")
                .selectAll("rect")
                .style("opacity", 0.0);
        });
    }

    function renderAttention(svg, attention) {

        // Remove previous dom elements
        svg.select("#attention").remove();

        // Add new elements
        svg.append("g")
            .attr("id", "attention") // Container for all attention arcs
            .selectAll(".headAttention")
            .data(attention)
            .enter()
            .append("g")
            .classed("headAttention", true) // Group attention arcs by head
            .attr("head-index", (d, i) => i)
            .selectAll(".tokenAttention")
            .data(d => d)
            .enter()
            .append("g")
            .classed("tokenAttention", true) // Group attention arcs by left token
            .attr("left-token-index", (d, i) => i)
            .selectAll("line")
            .data(d => d)
            .enter()
            .append("line")
            .attr("x1", BOXWIDTH)
            .attr("y1", function () {
                const leftTokenIndex = +this.parentNode.getAttribute("left-token-index")
                return TEXT_TOP + leftTokenIndex * BOXHEIGHT + (BOXHEIGHT / 2)
            })
            .attr("x2", BOXWIDTH + MATRIX_WIDTH)
            .attr("y2", (d, rightTokenIndex) => TEXT_TOP + rightTokenIndex * BOXHEIGHT + (BOXHEIGHT / 2))
            .attr("stroke-width", 2)
            .attr("stroke", function () {
                const headIndex = +this.parentNode.parentNode.getAttribute("head-index");
                return headColors(headIndex)
            })
            .attr("left-token-index", function () {
                return +this.parentNode.getAttribute("left-token-index")
            })
            .attr("right-token-index", (d, i) => i)
        ;
        updateAttention(svg)
    }

    function updateAttention(svg) {
        svg.select("#attention")
            .selectAll("line")
            .attr("stroke-opacity", function (d) {
                const headIndex = +this.parentNode.parentNode.getAttribute("head-index");
                // If head is selected
                if (config.headVis[headIndex]) {
                    // Set opacity to attention weight divided by number of active heads
                    return d / activeHeads()
                } else {
                    return 0.0;
                }
            })
    }

    function boxOffsets(i) {
        const numHeadsAbove = config.headVis.reduce(
            function (acc, val, cur) {
                return val && cur < i ? acc + 1 : acc;
            }, 0);
        return numHeadsAbove * (BOXWIDTH / activeHeads());
    }

    function activeHeads() {
        return config.headVis.reduce(function (acc, val) {
            return val ? acc + 1 : acc;
        }, 0);
    }

    function drawCheckboxes(top, svg) {
        const checkboxContainer = svg.append("g");
        const checkbox = checkboxContainer.selectAll("rect")
            .data(config.headVis)
            .enter()
            .append("rect")
            .attr("fill", (d, i) => headColors(i))
            .attr("x", (d, i) => i * CHECKBOX_SIZE)
            .attr("y", top)
            .attr("width", CHECKBOX_SIZE)
            .attr("height", CHECKBOX_SIZE);

        function updateCheckboxes() {
            checkboxContainer.selectAll("rect")
                .data(config.headVis)
                .attr("fill", (d, i) => d ? headColors(i): lighten(headColors(i)));
        }

        updateCheckboxes();

        checkbox.on("click", function (d, i) {
            if (config.headVis[i] && activeHeads() === 1) return;
            config.headVis[i] = !config.headVis[i];
            updateCheckboxes();
            updateAttention(svg);
        });

        checkbox.on("dblclick", function (d, i) {
            // If we double click on the only active head then reset
            if (config.headVis[i] && activeHeads() === 1) {
                config.headVis = new Array(config.nHeads).fill(true);
            } else {
                config.headVis = new Array(config.nHeads).fill(false);
                config.headVis[i] = true;
            }
            updateCheckboxes();
            updateAttention(svg);
        });
    }

    function lighten(color) {
        const c = d3.hsl(color);
        const increment = (1 - c.l) * 0.6;
        c.l += increment;
        c.s -= increment;
        return c;
    }

    function transpose(mat) {
        return mat[0].map(function (col, i) {
            return mat.map(function (row) {
                return row[i];
            });
        });
    }

});
</script>
